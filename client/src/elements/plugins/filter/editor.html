<link rel="import" href="../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-styles/color.html">
<link rel="import" href="../../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../../bower_components/iron-label/iron-label.html">
<link rel="import" href="../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../shared-styles.html">

<dom-module id="common-filter-editor">
    <template>
    	<style include="shared-dialog-styles"></style>
        <paper-dialog id="dialog" modal>
        	<div>
        		<iron-label>
		            <div class="headerDiv">
		                <span>Filter Plugin Editor</span>
		        	</div>
		        </iron-label>
	            <!-- User cannot enter title value beginning with a number -->
	            <paper-input id='TabTitle' label="[[editortitle]]" 
	                         required auto-validate allowed-pattern="^[a-zA-Z](.*[a-zA-Z0-9 ])?$" 
	                         error-message="Title is Required"></paper-input>
	            <paper-input id='filteroutputlimit' allowed-pattern="[\d]" label="Output Limit" value="10000"></paper-input>
	            <vaadin-combo-box id='filterInputTab' on-value-changed='changeInput' required label="Input Dataset"></vaadin-combo-box>
	            <vaadin-combo-box id='field' required label="Field"></vaadin-combo-box>
	            <vaadin-combo-box id='operation' required label="Operation" items='["=", ">", "<",">=","<=","IN","BETWEEN"]'></vaadin-combo-box>
	            <paper-input id='formulavalue' label="Value"></paper-input>
	            <paper-button on-tap="andFunction" class="addBtn">AND</paper-button>
	            <paper-button on-tap="orFunction" class="addBtn">OR</paper-button>
	            <paper-input id='filterformulas' label="Value"></paper-input>
				<vaadin-combo-box id='sortfields' required label="Sort By"></vaadin-combo-box>
                <paper-button on-tap="addSortFunction" class="addBtn">ADD</paper-button>
                <paper-input id='sortbyfieldsvalue' label="Sort Order"></paper-input>
	            <br><br><br>
	            <div class="buttons">
	                <paper-button dialog-confirm raised class="indigo" on-tap="_okHandler">Ok</paper-button>
	                <paper-button dialog-dismiss raised class="green">Cancel</paper-button>
	            </div>
	        </div>
        </paper-dialog>
    </template>
    <script>
    Polymer({
        is: 'common-filter-editor',


	properties: {


		inputeclcode : {
                    type: Object,
                     value: function() { return {}; } 
                },

		outputdsname : {
                    type: Object,
                     value: function() { return {}; } 
                },

		inputdsname : {
                    type: Object,
                     value: function() { return {}; } 
                },


		hpccuser : {
                    type: Object,
                     value: function() { return {}; } 
                },


		editortitle : {
                    type: Object,
                     value: function() { return {}; } 
                },

		displayFields : {
                    type: Object,
                     value: function() { return {}; } 
                },

		expression : {
                    type: Object,
                     value: function() { return {}; } 
                },
		title: {
			type: Object,
			value: function() { return []; }
		},
	eclcode: {
				type: Object,
				value: function() { return {}; }
			}
	},

	ready : function(){
		var selpage = document.querySelector("#pages").querySelector("#common-input");
		var infoBox = document.querySelector('#infobox');
		var username = infoBox.username;
		var password = infoBox.password;
		var credentials = username === null || username === "" ? "" : (
		password === null || password === "" ?  (username + '@') :
		(username + ':' + password + '@')               
		);
		var eclIP = (infoBox.isHpccSecured === "true" ? "https://" : "http://") +  infoBox.cluster_address +
		":" + infoBox.port;
		this.eclIP = eclIP;
		this.hpccuser = username;

		this.displayFields = '';
		this.eclcode = '';
		this.inputeclcode = '';
		this.editortitle = '';
		this.$.TabTitle.value = '';
		this.inputdsname = '';
		this.outputdsname = '';
		this.expression = '';
	},

deSerialize : function(tabTtitle){

 var jsonTabContent  = null;

  var infoBox = document.querySelector('#infobox');

  var tabs = infoBox.properties.tabsdata.Tabs;

   for(var cnt = 0; cnt < tabs.length; cnt++){
		if( tabTtitle === tabs[cnt].title){
			jsonTabContent = tabs[cnt];
			this.displayFields = jsonTabContent.displayFields;
			this.$.field.items = this.displayFields.split(",");
			this.$.TabTitle.value = jsonTabContent.title;
			this.editortitle = jsonTabContent.title;
			this.eclcode = jsonTabContent.eclcode;
			this.inputeclcode = jsonTabContent.eclcode;
			this.inputdsname = jsonTabContent.inputdsname;
			this.outputdsname = jsonTabContent.outputdsname;
			this.pluginId = jsonTabContent.pluginId;
			this.title = jsonTabContent.title;
			this.expression = jsonTabContent.expression;
			this.$.filterformulas.value = jsonTabContent.expression; 
			this.$.filterInputTab.value = jsonTabContent.inputdsname;
			
		   break;
		}
   }
},

serialize : function(){
	var jsonStr = '{';
	jsonStr += '\"displayFields\" : \"' + this.displayFields + '\",';
	jsonStr += '\"editortitle\" : \"' + this.editortitle + '\",';
	jsonStr += '\"eclcode\" : \"' + this.eclcode.replace(/[\r\n]/g, '') + '\",';
	jsonStr += '\"inputdsname\" :\" ' + this.inputdsname + '\",';
	jsonStr += '\"outputdsname\" : \"' + this.outputdsname + '\",';
	jsonStr += '\"expression\" : \"' + this.expression + '\",';
	jsonStr += '\"title\" : \"' + this.title.trim() + '\",';
	jsonStr += '\"pluginId\" : \"' + 'common-filter' + '\"}';

	return jsonStr;
},
loadgrid : function(tabTtitle){
	var QueryStr1 =  this.eclcode;
	if(QueryStr1.trim() === ''){
		return;
	}
	var QueryStr =  QueryStr1 +  "\n OUTPUT(" + this.outputdsname + ");";
	return loadGridwithEcl(QueryStr, 1000);
},


open: function () {

	Polymer.dom(this.$.dialog).querySelector("#TabTitle").label = document.querySelector("#tabs").selectedItem.textContent;

    this.$.TabTitle.value = document.querySelector("#tabs").selectedItem.textContent;

	var pages = document.querySelector("#tabs");

	var tabnames = "";

	for(var cnt =0 ; cnt < document.getElementsByTagName("paper-tab").length; cnt++){
		if(pages.selectedItem.id === document.getElementsByTagName("paper-tab")[cnt].id){
			break;
		}
		tabnames += (tabnames === "" ? "" : ",") + document.getElementsByTagName("paper-tab")[cnt].textContent.trim();
	}
	this.$.dialog.querySelector("#filterInputTab").items = tabnames.split(",");



	this.$.dialog.open();
},

_okHandler: function (e) {
	document.querySelector("#tabs").selectedItem.textContent = this.$.TabTitle.value;
	this.title  = this.$.TabTitle.value;
	var currentPage = document.querySelector("#pages").selectedItem;

	currentPage.outputdsname = 'filterdsName'  + '_' +  Math.random().toString(36).substr(2, 4);

	var infoBox = document.querySelector('#infobox');

	this.outputdsname = currentPage.outputdsname;

	var QueryStr1 =  this.inputeclcode + "\n" + currentPage.outputdsname + " := " + 
					 this.inputdsname + "(" +                                
					 this.$.filterformulas.value + ");";

    this.expression = this.$.filterformulas.value;

	var QueryStr =  QueryStr1 +  "\n OUTPUT(" + ( this.$.sortbyfieldsvalue.value.length > 0 ? ( 'SORT(' + currentPage.outputdsname + ',' + this.$.sortbyfieldsvalue.value +')' ) : currentPage.outputdsname) + ");";

	var eclIP = (infoBox.isHpccSecured === "true" ? "https://" : "http://") + 
				// (this.hpccuser != '' ? this.hpccuser + ':' + this.password + '@' : '')  +
					infoBox.cluster_address +
					":" + infoBox.port;

	currentPage.eclcode = QueryStr1;
	this.eclcode = QueryStr1;

	return loadGridwithEcl(QueryStr, this.$.filteroutputlimit.value);
},
changeInput: function(e){

	var tabid = "";

	for(var cnt =0 ; cnt < document.getElementsByTagName("paper-tab").length; cnt++){
		if(event.currentTarget.value === document.getElementsByTagName("paper-tab")[cnt].textContent.trim()){
			tabid =  document.getElementsByTagName("paper-tab")[cnt].id;
			break;
		}
	}

    if(tabid === ''){
        return;
    }

	var selpage = document.querySelector("#pages").querySelector("#" + tabid);

	this.eclcode = selpage.editor.eclcode;

	this.inputeclcode = selpage.editor.eclcode;

	this.inputdsname = selpage.editor.outputdsname;

	this.displayFields = selpage.editor.displayFields;

	this.$.field.items = selpage.editor.displayFields.split(",");

    this.$.sortfields.items = [];

	var fieldList = [];

	var splitstrs =  selpage.editor.displayFields.split(',');
	for(var cnt = 0; cnt < splitstrs.length; cnt++ ){
		fieldList.push('+' + splitstrs[cnt]);
		fieldList.push('-' + splitstrs[cnt]);
	}

    this.$.sortfields.items = fieldList;

	return;

    },
    andFunction: function (e) {
        this.$.filterformulas.value = this.$.filterformulas.value + (this.$.filterformulas.value.length > 0 ? " AND " : "") + this.$.field.value + ' ' + this.$.operation.value + ' ' + this.$.formulavalue.value ;            
    },

	addSortFunction: function (e) {
		var splitstrs = this.$.sortbyfieldsvalue.value.split(',');
		for(var cnt = 0; cnt < splitstrs.length; cnt++ ){
			if(splitstrs[cnt].trim().substring(1) === this.$.sortfields.value.substring(1) ){
				return;
			}
		}

        this.$.sortbyfieldsvalue.value = this.$.sortbyfieldsvalue.value + (this.$.sortbyfieldsvalue.value.length > 0 ? " ," : "") + this.$.sortfields.value  ;            
    },

		
        
    orFunction: function (e) {
        this.$.filterformulas.value = this.$.filterformulas.value + (this.$.filterformulas.value.length > 0 ? " OR " : "") + this.$.field.value + ' ' + this.$.operation.value + ' ' +this.$.formulavalue.value ;
    },
    _cancelHandler: function (e) {
        this.fire('cancel');
    },

    setGeneralProperties: function (properties) {

    },

    setViewProperties: function(properties) {

    },

    getViewProperties: function() {

    }
});
    </script>
</dom-module>
